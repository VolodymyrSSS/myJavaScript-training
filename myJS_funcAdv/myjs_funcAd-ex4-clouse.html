<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>myjs_funcAdv: exercise Замыкание</title>
    <style>
    body {
        background-color: tan;
        margin: 0;
        font-family: Verdana, sans-serif;
    }

    .title {
        color: red;
        text-align: center;
        font-weight:700;
    }

    .code-ex {
        width: 50%;
        font-family: sans-serif;
        background-color: #bebebe;
        font-size: large;
        padding-left: 15px;
        margin: 0 auto;
    }

    .task{
        width: 50%;
        padding: 15px 25px;
        color: navy;
        background-color: #e2e2e2;
        margin: 35px auto;
    }

    .code-ex {
        width: 50%;
        font-family: sans-serif;
        background-color: #bebebe;
        font-size: large;
        padding-left: 15px;
        margin: 0 auto;
    }

    p {
        width: 80%;
        margin: 0 auto;
    }
    </style>
</head>
<body>

    <h2 class="title">myjs_funcAdv: exercise Замыкание</h2>

    <h4 class="task"> Мы знаем, что функция может получить доступ к переменным из внешнего окружения, эта 
        возможность используется очень часто.<br> 
        У нас есть функция 'sayHi', которая использует внешнюю переменную 'name'. Что произойдёт, когда 
        внешняя переменная изменятся? Функция получит последнее значение или то, которое существовало 
        на момент создания функции? Или какое значение будет использовать функция при выполнении? Что 
        будет показано: 'John' или 'Pete'?<br>
        Дайте определение замыканию?
    </h4>

    <p class="code-ex">
        <code>
            let name = 'John';<br>
            <br>
            function sayHi() { console.log('Hi, ' + name); }<br>
            <br>
            name = 'Pete';<br>
            <br>
            sayHi(); // <b>???</b><br>
        </code>
    </p><br>

    <p><b>Решение</b>:<br>
        <br>
        В процессе вызова функции у нас есть два лексических окружения: внутреннее (для вызываемой функции) и внешнее (глобальное):
        Внутреннее лексическое окружение соответствует текущему выполнению sayHi, в нём нет переменных.<br>
        Внешнее лексическое окружение – это глобальное лексическое окружение. В глобальном лексическом окружении есть name: 'John'.        
        У внутреннего лексического окружения есть ссылка outer на внешнее.<br>
        Когда код хочет получить доступ к переменной – сначала происходит поиск во внутреннем лексическом окружении, затем во внешнем, 
        затем в следующем и так далее, до глобального и<br>
        <b>функция получает текущее значение внешних переменных, то есть, их последнее значение</b>.<br>
        На строке name = 'Pete'; глобальная переменная изменяется, теперь  текущее значение - 'Pete'.<br>
        Поэтому, на момент, когда выполняется функция sayHi(), она не находит никакой переменной внутри и берёт переменную 'name' 
        извне - из глобального лексического окружения, где переменная уже равна 'Pete'.
        <br>
        <em>Заметим, если переменная не была найдена, это будет ошибкой в strict mode. Без strict mode, для обратной совместимости, 
        присваивание несуществующей переменной создаёт новую глобальную переменную с таким именем.</em><br>
    </p><br>

    <p class="code-ex">
        <code>
            sayHi(); // Hi, <b>Pete</b><br>
        </code>
    </p><br>

    <script>
        let name = "John";

        function sayHi() {
            console.log("Hi, " + name);
        }

        name = "Pete";

        sayHi(); // Hi, Pete

    </script>

    <p>В JavaScript у каждой выполняемой функции, блока кода и скрипта есть связанный с ними внутренний (скрытый) объект, 
        называемый лексическим окружением LexicalEnvironment. Объект лексического окружения состоит из двух частей:<br>
        1. Environment Record – объект, в котором как свойства хранятся все локальные переменные (а также некоторая другая информация, 
        такая как значение this).<br>
        2. Ссылка на внешнее лексическое окружение – то есть то, которое соответствует коду снаружи (снаружи от текущих фигурных 
        скобок).
    </p><br>

    <p>«Лексическое окружение» – это специальный внутренний объект. Мы не можем получить его в нашем коде и изменять напрямую. 
    Сам движок JavaScript может оптимизировать его, уничтожать неиспользуемые переменные для освобождения памяти и выполнять 
    другие внутренние уловки.
    </p><br>

    <p>Все функции «при рождении» получают скрытое свойство [[Environment]], которое ссылается на лексическое окружение места, где 
        они были созданы. Другими словами, функция навсегда запоминает ссылку на лексическое окружение, где она была создана. 
        И [[Environment]] – скрытое свойство функции, которое содержит эту ссылку.<br>
        В данном случае, sayHi создан в глобальном лексическом окружении, так что [[Environment]] содержит ссылку на него. 
        Кроме того, в отличие от переменных, объявленных с помощью let, функции Function Declaration 
        полностью инициализируются не тогда, когда выполнение доходит до них, а раньше, когда создаётся лексическое окружение.
    </p><br>

    <p>Исходя с изложеного, <b>замыкание – это функция, которая запоминает свои внешние переменные и может получить к ним доступ</b>.
        Все функции в JavaScript являются замыканиями.
    </p><br>


</body>

</html>